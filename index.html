<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SKY HRT Solutions</title>
    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/payslip_system.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Additional styles for improved PDF viewer */
        .payslip-wrapper {
            position: relative;
            margin: 20px 0;
        }
        
        .payslip-container {
            position: relative;
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: auto;
            background-color: #f5f5f5;
        }
        
        .payslip-placeholder {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #pdfViewer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: white;
        }
        
        .payslip-controls {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-btn {
            background: #4a6fdc;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 4px;
            padding: 8px 12px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-btn:hover {
            background: #3a5bc9;
        }
        
        .payslip-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        /* Modal for fullscreen on mobile */
        .pdf-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }
        
        .pdf-modal-content {
            width: 100%;
            position: relative;
            padding: 20px;
        }
        
        .pdf-modal-close {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            z-index: 1001;
        }
        
        /* Loading indicator */
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Save options modal */
        .save-options-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        
        .save-options-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .save-options-title {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
        }
        
        .save-options-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .save-option-btn {
            padding: 12px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .save-single-btn {
            background-color: #4CAF50;
            color: white;
        }
        
        .save-single-btn:hover {
            background-color: #45a049;
        }
        
        .save-all-btn {
            background-color: #2196F3;
            color: white;
        }
        
        .save-all-btn:hover {
            background-color: #0b7dda;
        }
        
        .save-gallery-btn {
            background-color: #9C27B0;
            color: white;
        }
        
        .save-gallery-btn:hover {
            background-color: #7B1FA2;
        }
        
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        
        .cancel-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .payslip-container {
                height: 70vh;
            }
            
            .control-btn {
                font-size: 0.9rem;
                padding: 6px 10px;
            }
            
            .payslip-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <button class="language-toggle" id="languageToggle">
        <i class="fas fa-language"></i> English
    </button>

    <div class="container">
        <header>
            <div class="logo">
                <img src="static/logo.png" alt="Company Logo" class="logo-image" />
                <div class="logo-text">SKY HRT Solutions</div>
            </div>
            <div class="tagline">Human Resources & Technology Excellence</div>
        </header>

        <div class="card" id="loginCard">
            <h2 id="loginTitle">Employee Login</h2>
            <div class="form-group">
                <label for="hrid" id="hridLabel">HR ID</label>
                <input type="text" id="hrid" placeholder="Enter your HR ID" />
            </div>
            <div class="form-group">
                <label for="nid" id="nidLabel">National ID (NID)</label>
                <input
                type="text"
                id="nid"
                placeholder="Enter your 14-digit National ID"
                maxlength="14"
                />
                <small
                style="color: var(--text-gray); display: block; margin-top: 5px"
                >NID must be exactly 14 digits</small
                >
            </div>
            <button id="loginBtn">Login</button>

            <div style="text-align: center; margin-top: 20px">
                <a href="#" id="adminLoginLink">HR Admin Login</a>
            </div>
        </div>

        <div class="card" id="adminLoginCard" style="display: none">
            <h2 id="adminLoginTitle">HR Admin Login</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter admin username" />
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input
                type="password"
                id="password"
                placeholder="Enter admin password"
                />
            </div>
            <button id="adminLoginBtn">Login</button>

            <div style="text-align: center; margin-top: 20px">
                <a href="#" id="employeeLoginLink">Employee Login</a>
            </div>
        </div>

        <div class="card" id="employeeDashboard" style="display: none">
            <h2 id="dashboardTitle">Employee Dashboard</h2>
            <div class="welcome-message">
                <span id="welcomeText">Welcome,</span>
                <span id="employeeName">Employee Name</span>
            </div>

            <div class="form-group">
                <label for="monthSelect" id="monthLabel">Select Month</label>
                <select id="monthSelect">
                    <option value="">-- Select Month --</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>

            <div class="payslip-wrapper" id="payslipWrapper" style="display: none;">
                <div class="payslip-controls" id="payslipControls">
                    <button class="control-btn" id="fullscreenBtn" title="Fullscreen">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                    <button class="control-btn" id="saveBtn" title="Save as Image">
                        <i class="fas fa-download"></i> Save
                    </button>
                </div>
                <div class="payslip-container" id="payslip-container">
                    <div class="payslip-placeholder" id="payslipPlaceholder">
                        <i
                          class="fas fa-file-pdf"
                          style="font-size: 3rem; margin-bottom: 15px"
                        ></i>
                        <p id="payslipHint">Select a month to view your payslip</p>
                    </div>
                </div>
            </div>

            <button class="logout" id="employeeLogout">Logout</button>
        </div>

        <!-- PDF Modal for mobile fullscreen -->
        <div class="pdf-modal" id="pdfModal">
            <div class="pdf-modal-content">
                <span class="pdf-modal-close" id="pdfModalClose">&times;</span>
                <div id="pdfModalViewer"></div>
            </div>
        </div>

        <!-- Save Options Modal -->
        <div class="save-options-modal" id="saveOptionsModal">
            <div class="save-options-content">
                <h3 class="save-options-title">Save as Image</h3>
                <p>How would you like to save the payslip?</p>
                <div class="save-options-buttons">
                    <button class="save-option-btn save-single-btn" id="saveSingleBtn">
                        <i class="fas fa-image"></i> Current Page
                    </button>
                    <button class="save-option-btn save-all-btn" id="saveAllBtn">
                        <i class="fas fa-images"></i> All Pages
                    </button>
                    <button class="save-option-btn save-gallery-btn" id="saveGalleryBtn">
                        <i class="fas fa-mobile-alt"></i> Save to Gallery
                    </button>
                    <button class="save-option-btn cancel-btn" id="cancelSaveBtn">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>

        <div class="card" id="adminDashboard" style="display: none">
            <h2>HR Admin Dashboard</h2>
            <div class="welcome-message">
                Welcome, <span>Ehab</span>. Empower your workforce with excellence!
            </div>

            <div class="admin-panel">
                <div class="admin-card" id="uploadExcelBtn">
                    <div class="admin-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>Upload Employee Data</h3>
                    <p>Upload Excel file with employee information</p>
                </div>
                <div class="admin-card" id="uploadPayslipsBtn">
                    <div class="admin-icon">
                        <i class="fas fa-file-upload"></i>
                    </div>
                    <h3>Upload Payslips</h3>
                    <p>Upload new PDF payslips for employees</p>
                </div>

                <div class="admin-card" id="deletePayslipsBtn">
                    <div class="admin-icon">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <h3>Delete Payslips</h3>
                    <p>Remove all existing payslips</p>
                </div>
            </div>

            <div id="uploadArea" style="display: none">
                <div class="drag-drop-area" id="dragDropArea">
                    <div class="drag-drop-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3>Drag & Drop PDF Files</h3>
                    <p>or click to browse your files</p>
                    <p>Files should be named: Payslip_HRID_MONTH.pdf</p>
                    <input
                    type="file"
                    id="fileInput"
                    multiple
                    accept=".pdf"
                    style="display: none"
                    />
                </div>
                <div id="uploadStatus"></div>
                <button id="doneUploadBtn">Done</button>
            </div>

            <div id="uploadExcelArea" style="display: none">
                <div class="drag-drop-area" id="dragDropExcelArea">
                    <div class="drag-drop-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>Drag & Drop Excel File</h3>
                    <p>or click to browse your files</p>
                    <p>File should be in .xlsx or .xlsm format</p>
                    <input
                    type="file"
                    id="excelFileInput"
                    accept=".xlsx,.xlsm"
                    style="display: none"
                    />
                </div>
                <div id="excelUploadStatus"></div>
                <button id="doneExcelUploadBtn">Done</button>
            </div>

            <button class="logout" id="adminLogout">Logout</button>
        </div>
    </div>

    <div class="confirmation-modal" id="deleteModal">
        <div class="modal-content">
            <h3>Confirm Deletion</h3>
            <p>Are you sure you want to delete all payslip files? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="secondary" id="cancelDelete">Cancel</button>
                <button id="confirmDelete">Delete All</button>
            </div>
        </div>
    </div>

    <script>
        // Set the worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        // Language support
        const translations = {
            en: {
                loginTitle: "Employee Login",
                hridLabel: "HR ID",
                nidLabel: "National ID (NID)",
                loginBtn: "Login",
                adminLoginLink: "HR Admin Login",
                adminLoginTitle: "HR Admin Login",
                employeeLoginLink: "Employee Login",
                dashboardTitle: "Employee Dashboard",
                welcomeText: "Welcome,",
                monthLabel: "Select Month",
                payslipHint: "Select a month to view your payslip",
                salaryNotCash: "Your salary not cash",
                logout: "Logout",
                months: [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December",
                ],
            },
            ar: {
                loginTitle: "تسجيل دخول الموظف",
                hridLabel: "معرف الموارد البشرية",
                nidLabel: "الهوية الوطنية",
                loginBtn: "تسجيل الدخول",
                adminLoginLink: "تسجيل دخول المشرف",
                adminLoginTitle: "تسجيل دخول مشرف الموارد البشرية",
                employeeLoginLink: "تسجيل دخول الموظف",
                dashboardTitle: "لوحة تحكم الموظف",
                welcomeText: "أهلاً بك,",
                monthLabel: "اختر الشهر",
                payslipHint: "اختر شهراً لعرض إيصال الراتب",
                salaryNotCash: "لا يوجد بيان راتب لهذا الشهر",
                logout: "تسجيل الخروج",
                months: [
                    "يناير",
                    "فبراير",
                    "مارس",
                    "أبريل",
                    "مايو",
                    "يونيو",
                    "يوليو",
                    "أغسطس",
                    "سبتمبر",
                    "أكتوبر",
                    "نوفمبر",
                    "ديسمبر",
                ],
            },
        };

        let currentLang = "en";
        let currentPdfUrl = null;
        let pdfPages = [];
        const languageToggle = document.getElementById("languageToggle");

        languageToggle.addEventListener("click", () => {
            currentLang = currentLang === "en" ? "ar" : "en";
            updateLanguage();
        });

        function updateLanguage() {
            document.body.dir = currentLang === "ar" ? "rtl" : "ltr";
            languageToggle.innerHTML =
                currentLang === "en"
                    ? '<i class="fas fa-language"></i> English'
                    : '<i class="fas fa-language"></i> العربية';

            // Update all elements with translations
            for (const [key, value] of Object.entries(translations[currentLang])) {
                const elements = document.querySelectorAll(`[id="${key}"]`);
                elements.forEach((el) => {
                    if (el.tagName === "INPUT" && el.placeholder) {
                        el.placeholder = value;
                    } else {
                        el.textContent = value;
                    }
                });
            }

            // Update month dropdown
            if (currentLang === "ar") {
                const monthSelect = document.getElementById("monthSelect");
                monthSelect.innerHTML = '<option value="">-- اختر الشهر --</option>';
                translations.ar.months.forEach((month, index) => {
                    const option = document.createElement("option");
                    option.value = (index + 1).toString().padStart(2, "0");
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
            }
        }

        // DOM elements
        const loginCard = document.getElementById("loginCard");
        const adminLoginCard = document.getElementById("adminLoginCard");
        const employeeDashboard = document.getElementById("employeeDashboard");
        const adminDashboard = document.getElementById("adminDashboard");
        const adminLoginLink = document.getElementById("adminLoginLink");
        const employeeLoginLink = document.getElementById("employeeLoginLink");
        const loginBtn = document.getElementById("loginBtn");
        const adminLoginBtn = document.getElementById("adminLoginBtn");
        const employeeLogout = document.getElementById("employeeLogout");
        const adminLogout = document.getElementById("adminLogout");
        const monthSelect = document.getElementById("monthSelect");
        const payslipPlaceholder = document.getElementById("payslipPlaceholder");
        const payslipWrapper = document.getElementById("payslipWrapper");
        const payslipControls = document.getElementById("payslipControls");
        const fullscreenBtn = document.getElementById("fullscreenBtn");
        const saveBtn = document.getElementById("saveBtn");
        const uploadExcelBtn = document.getElementById("uploadExcelBtn");
        const uploadPayslipsBtn = document.getElementById("uploadPayslipsBtn");
        const deletePayslipsBtn = document.getElementById("deletePayslipsBtn");
        const uploadArea = document.getElementById("uploadArea");
        const uploadExcelArea = document.getElementById("uploadExcelArea");
        const dragDropArea = document.getElementById("dragDropArea");
        const dragDropExcelArea = document.getElementById("dragDropExcelArea");
        const fileInput = document.getElementById("fileInput");
        const excelFileInput = document.getElementById("excelFileInput");
        const doneUploadBtn = document.getElementById("doneUploadBtn");
        const doneExcelUploadBtn = document.getElementById("doneExcelUploadBtn");
        const deleteModal = document.getElementById("deleteModal");
        const cancelDelete = document.getElementById("cancelDelete");
        const confirmDelete = document.getElementById("confirmDelete");
        const nidInput = document.getElementById("nid");
        const pdfModal = document.getElementById("pdfModal");
        const pdfModalClose = document.getElementById("pdfModalClose");
        const pdfModalViewer = document.getElementById("pdfModalViewer");
        const saveOptionsModal = document.getElementById("saveOptionsModal");
        const saveSingleBtn = document.getElementById("saveSingleBtn");
        const saveAllBtn = document.getElementById("saveAllBtn");
        const saveGalleryBtn = document.getElementById("saveGalleryBtn");
        const cancelSaveBtn = document.getElementById("cancelSaveBtn");

        // NID validation - allow only numbers and limit to 14 digits
        nidInput.addEventListener("input", function () {
            this.value = this.value.replace(/\D/g, "").slice(0, 14);
        });

        // Event listeners
        adminLoginLink.addEventListener("click", (e) => {
            e.preventDefault();
            loginCard.style.display = "none";
            adminLoginCard.style.display = "block";
        });

        employeeLoginLink.addEventListener("click", (e) => {
            e.preventDefault();
            adminLoginCard.style.display = "none";
            loginCard.style.display = "block";
        });

        // Employee login with API call
        loginBtn.addEventListener("click", async () => {
            const hrid = document.getElementById("hrid").value;
            const nid = document.getElementById("nid").value;

            // Validate NID length
            if (nid.length !== 14) {
                showMessage("National ID must be exactly 14 digits.", "error");
                return;
            }

            try {
                const response = await fetch("/login_employee", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ hrid, nid }),
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById("employeeName").textContent = data.name;
                    loginCard.style.display = "none";
                    employeeDashboard.style.display = "block";
                } else {
                    showMessage(data.error || "Invalid HR ID or NID. Please try again.", "error");
                }
            } catch (error) {
                showMessage("Login failed. Please check your connection and try again.", "error");
            }
        });

        // Admin login with API call
        adminLoginBtn.addEventListener("click", async () => {
            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            try {
                const response = await fetch("/login_admin", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (data.success) {
                    adminLoginCard.style.display = "none";
                    adminDashboard.style.display = "block";
                } else {
                    showMessage(data.error || "Invalid username or password. Please try again.", "error");
                }
            } catch (error) {
                showMessage("Login failed. Please check your connection and try again.", "error");
            }
        });

        employeeLogout.addEventListener("click", () => {
            employeeDashboard.style.display = "none";
            loginCard.style.display = "block";
            document.getElementById("hrid").value = "";
            document.getElementById("nid").value = "";
            monthSelect.value = "";
            payslipWrapper.style.display = "none";
            payslipPlaceholder.innerHTML =
                '<i class="fas fa-file-pdf" style="font-size: 3rem; margin-bottom: 15px;"></i><p id="payslipHint">Select a month to view your payslip</p>';
        });

        adminLogout.addEventListener("click", () => {
            adminDashboard.style.display = "none";
            adminLoginCard.style.display = "block";
            uploadArea.style.display = "none";
            uploadExcelArea.style.display = "none";
            document.getElementById("username").value = "";
            document.getElementById("password").value = "";
        });

        // Function to render PDF
        async function renderPdf(url, container, showControls = true) {
            // Store current PDF URL
            currentPdfUrl = url;
            
            // Show loading indicator
            container.innerHTML = `
                <div class="pdf-loading">
                    <div class="spinner"></div>
                    <p>Loading PDF...</p>
                </div>
            `;

            try {
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                
                // Clear loading indicator
                container.innerHTML = '';
                
                // Create a div to hold all pages
                const pdfViewer = document.createElement('div');
                pdfViewer.id = 'pdfViewer';
                container.appendChild(pdfViewer);
                
                // Reset pages array
                pdfPages = [];
                
                // Render each page
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1.5 }); // Adjust scale as needed
                    
                    // Create canvas for this page
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.className = 'pdf-page';
                    canvas.setAttribute('data-page-num', pageNum);
                    
                    // Render PDF page
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                    
                    // Add canvas to viewer
                    pdfViewer.appendChild(canvas);
                    
                    // Store canvas reference for saving
                    pdfPages.push(canvas);
                }
                
                // Show controls if needed
                if (showControls) {
                    payslipControls.style.display = 'flex';
                }
                
            } catch (error) {
                console.error('Error rendering PDF:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--error-color);"></i>
                        <p>${currentLang === "en" ? "Error loading PDF" : "خطأ في تحميل ملف PDF"}</p>
                    </div>
                `;
            }
        }

        // Month selection with API call
        monthSelect.addEventListener("change", async () => {
            const month = monthSelect.value;

            if (month && document.getElementById("employeeName").textContent) {
                payslipWrapper.style.display = "block";
                try {
                    const hrid = document.getElementById("hrid").value;
                    const response = await fetch(`/get_payslip/${hrid}/${month}`);

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        
                        // Use PDF.js to render the PDF
                        renderPdf(url, payslipPlaceholder);
                    } else {
                        const errorData = await response.json();
                        payslipPlaceholder.innerHTML = `
                            <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--error-color);"></i>
                            <p>${errorData.error || (currentLang === "en" ? "Your salary not cash" : "لا يوجد بيان راتب لهذا الشهر")}</p>
                        `;
                        payslipControls.style.display = 'none';
                    }
                } catch (error) {
                    payslipPlaceholder.innerHTML = `
                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; margin-bottom: 15px; color: var(--error-color);"></i>
                        <p>${currentLang === "en" ? "Error loading payslip" : "خطأ في تحميل إيصال الراتب"}</p>
                    `;
                    payslipControls.style.display = 'none';
                }
            } else {
                payslipWrapper.style.display = "none";
            }
        });

        // Fullscreen button event
        fullscreenBtn.addEventListener("click", () => {
            if (currentPdfUrl) {
                openPdfModal(currentPdfUrl);
            }
        });

        // Save button event
        saveBtn.addEventListener("click", () => {
            if (pdfPages.length > 0) {
                showSaveOptions();
            }
        });

        uploadExcelBtn.addEventListener("click", () => {
            uploadExcelArea.style.display = "block";
        });

        dragDropExcelArea.addEventListener("click", () => {
            excelFileInput.click();
        });

        excelFileInput.addEventListener("change", (e) => {
            if (e.target.files.length > 0) {
                processExcelFile(e.target.files[0]);
            }
        });

        dragDropExcelArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            dragDropExcelArea.style.borderColor = "var(--secondary-accent)";
            dragDropExcelArea.style.backgroundColor = "rgba(255, 119, 0, 0.1)";
        });

        dragDropExcelArea.addEventListener("dragleave", () => {
            dragDropExcelArea.style.borderColor = "var(--primary-accent)";
            dragDropExcelArea.style.backgroundColor = "transparent";
        });

        dragDropExcelArea.addEventListener("drop", (e) => {
            e.preventDefault();
            dragDropExcelArea.style.borderColor = "var(--primary-accent)";
            dragDropExcelArea.style.backgroundColor = "transparent";

            if (e.dataTransfer.files.length > 0) {
                processExcelFile(e.dataTransfer.files[0]);
            }
        });

        doneExcelUploadBtn.addEventListener("click", () => {
            uploadExcelArea.style.display = "none";
        });

        function processExcelFile(file) {
            const statusElement = document.getElementById("excelUploadStatus");
            statusElement.innerHTML = "";

            if (!file.name.toLowerCase().endsWith(".xlsx") && !file.name.toLowerCase().endsWith(".xlsm")) {
                showMessage(`Invalid file type: ${file.name}`, "error", statusElement);
                return;
            }

            const formData = new FormData();
            formData.append("file", file);

            fetch("/upload_excel", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.error) {
                        showMessage(data.error, "error", statusElement);
                    } else {
                        showMessage(data.message, "success", statusElement);
                    }
                })
                .catch(() => {
                    showMessage("Error uploading Excel file", "error", statusElement);
                });
        }

        uploadPayslipsBtn.addEventListener("click", () => {
            uploadArea.style.display = "block";
        });

        deletePayslipsBtn.addEventListener("click", () => {
            deleteModal.style.display = "flex";
        });

        cancelDelete.addEventListener("click", () => {
            deleteModal.style.display = "none";
        });

        confirmDelete.addEventListener("click", () => {
            fetch("/delete_payslips", {
                method: "POST",
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.message) {
                        showMessage(data.message, "success");
                    } else {
                        showMessage("Error deleting payslips", "error");
                    }
                    deleteModal.style.display = "none";
                })
                .catch(() => {
                    showMessage("Error deleting payslips. Please try again.", "error");
                    deleteModal.style.display = "none";
                });
        });

        dragDropArea.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", (e) => {
            if (e.target.files.length > 0) {
                processFiles(e.target.files);
            }
        });

        dragDropArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            dragDropArea.style.borderColor = "var(--secondary-accent)";
            dragDropArea.style.backgroundColor = "rgba(255, 119, 0, 0.1)";
        });

        dragDropArea.addEventListener("dragleave", () => {
            dragDropArea.style.borderColor = "var(--primary-accent)";
            dragDropArea.style.backgroundColor = "transparent";
        });

        dragDropArea.addEventListener("drop", (e) => {
            e.preventDefault();
            dragDropArea.style.borderColor = "var(--primary-accent)";
            dragDropArea.style.backgroundColor = "transparent";

            if (e.dataTransfer.files.length > 0) {
                processFiles(e.dataTransfer.files);
            }
        });

        doneUploadBtn.addEventListener("click", () => {
            uploadArea.style.display = "none";
        });

        function processFiles(files) {
            const statusElement = document.getElementById("uploadStatus");
            statusElement.innerHTML = "";

            const formData = new FormData();
            let hasValidFile = false;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type !== "application/pdf") {
                    showMessage(`Skipped ${file.name}: Not a PDF file`, "error", statusElement);
                    continue;
                }

                // Check if filename follows the pattern
                if (!file.name.match(/^Payslip_.+_.+\.pdf$/i)) {
                    showMessage(`Skipped ${file.name}: Incorrect filename format`, "error", statusElement);
                    continue;
                }

                formData.append("files", file);
                hasValidFile = true;
            }

            if (!hasValidFile) {
                showMessage("No valid PDF files to upload", "error", statusElement);
                return;
            }

            fetch("/upload_payslips", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.uploaded && data.uploaded.length > 0) {
                        data.uploaded.forEach((filename) => {
                            showMessage(`Uploaded ${filename} successfully`, "success", statusElement);
                        });
                    } else {
                        showMessage("No files were uploaded", "error", statusElement);
                    }
                })
                .catch(() => {
                    showMessage("Error uploading files", "error", statusElement);
                });
        }

        function showMessage(text, type, parent = document.body) {
            const message = document.createElement("div");
            message.className = `message ${type}`;
            message.textContent = text;
            parent.appendChild(message);

            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        // PDF Modal functionality for mobile
        function openPdfModal(url) {
            // Clear previous content
            pdfModalViewer.innerHTML = '';
            
            // Render PDF in modal
            renderPdf(url, pdfModalViewer, false);
            
            // Show modal
            pdfModal.style.display = "flex";
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
        }

        // Close PDF modal
        pdfModalClose.addEventListener("click", () => {
            pdfModal.style.display = "none";
            pdfModalViewer.innerHTML = '';
            document.body.style.overflow = '';
        });

        // Close modal when clicking outside the content
        pdfModal.addEventListener("click", (e) => {
            if (e.target === pdfModal) {
                pdfModal.style.display = "none";
                pdfModalViewer.innerHTML = '';
                document.body.style.overflow = '';
            }
        });

        // Save as Image functionality
        function showSaveOptions() {
            saveOptionsModal.style.display = "flex";
        }

        // Close save options modal
        cancelSaveBtn.addEventListener("click", () => {
            saveOptionsModal.style.display = "none";
        });

        // Save current page as image
        saveSingleBtn.addEventListener("click", async () => {
            saveOptionsModal.style.display = "none";
            
            if (pdfPages.length === 0) {
                showMessage("No PDF pages to save", "error");
                return;
            }
            
            try {
                // Get the currently visible page (first page in view)
                const container = document.querySelector('#payslip-container');
                const scrollTop = container.scrollTop;
                
                // Find the page that's currently in view
                let currentPage = null;
                for (const page of pdfPages) {
                    const pageTop = page.offsetTop;
                    const pageBottom = pageTop + page.offsetHeight;
                    
                    if (scrollTop >= pageTop && scrollTop < pageBottom) {
                        currentPage = page;
                        break;
                    }
                }
                
                // If no page is found in view, use the first page
                if (!currentPage) {
                    currentPage = pdfPages[0];
                }
                
                // Convert canvas to image
                const dataUrl = currentPage.toDataURL('image/png');
                
                // Create download link
                const link = document.createElement('a');
                link.download = `Payslip_Page_${currentPage.getAttribute('data-page-num')}_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataUrl;
                link.click();
                
                showMessage("Page saved as image", "success");
            } catch (error) {
                console.error('Error saving page as image:', error);
                showMessage("Error saving page as image", "error");
            }
        });

        // Save all pages as images
        saveAllBtn.addEventListener("click", async () => {
            saveOptionsModal.style.display = "none";
            
            if (pdfPages.length === 0) {
                showMessage("No PDF pages to save", "error");
                return;
            }
            
            try {
                // Create a temporary container to combine all pages
                const tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.backgroundColor = 'white';
                document.body.appendChild(tempContainer);
                
                // Add all pages to the container
                for (const page of pdfPages) {
                    const clonedPage = page.cloneNode(true);
                    clonedPage.style.marginBottom = '20px';
                    tempContainer.appendChild(clonedPage);
                }
                
                // Convert the container to an image
                const canvas = await html2canvas(tempContainer, {
                    scale: 1,
                    backgroundColor: 'white'
                });
                
                // Remove the temporary container
                document.body.removeChild(tempContainer);
                
                // Convert canvas to image
                const dataUrl = canvas.toDataURL('image/png');
                
                // Create download link
                const link = document.createElement('a');
                link.download = `Payslip_All_Pages_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = dataUrl;
                link.click();
                
                showMessage("All pages saved as image", "success");
            } catch (error) {
                console.error('Error saving all pages as image:', error);
                showMessage("Error saving pages as image", "error");
            }
        });

        // Save to gallery functionality
        saveGalleryBtn.addEventListener("click", async () => {
            saveOptionsModal.style.display = "none";
            
            if (pdfPages.length === 0) {
                showMessage("No PDF pages to save", "error");
                return;
            }
            
            try {
                // Get the currently visible page (first page in view)
                const container = document.querySelector('#payslip-container');
                const scrollTop = container.scrollTop;
                
                // Find the page that's currently in view
                let currentPage = null;
                for (const page of pdfPages) {
                    const pageTop = page.offsetTop;
                    const pageBottom = pageTop + page.offsetHeight;
                    
                    if (scrollTop >= pageTop && scrollTop < pageBottom) {
                        currentPage = page;
                        break;
                    }
                }
                
                // If no page is found in view, use the first page
                if (!currentPage) {
                    currentPage = pdfPages[0];
                }
                
                // Convert canvas to image
                const dataUrl = currentPage.toDataURL('image/png');
                
                // For mobile devices, try to save to gallery
                if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    // Create a temporary link for download
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `Payslip_${new Date().toISOString().slice(0, 10)}.png`;
                    
                    // For iOS devices, we need to open in a new window
                    if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                        const win = window.open();
                        win.document.write(`<img src="${dataUrl}" />`);
                        showMessage("Image opened in new tab. Long press to save to gallery.", "success");
                    } else {
                        // For Android and other mobile devices
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showMessage("Image saved to gallery", "success");
                    }
                } else {
                    // For desktop, just download
                    const link = document.createElement('a');
                    link.download = `Payslip_${new Date().toISOString().slice(0, 10)}.png`;
                    link.href = dataUrl;
                    link.click();
                    showMessage("Image downloaded", "success");
                }
            } catch (error) {
                console.error('Error saving to gallery:', error);
                showMessage("Error saving image", "error");
            }
        });

        // Initialize the app
        updateLanguage();
    </script>
</body>
</html>